---
title: "Coursera_CleaningData_Assignment4"
author: "Joanna Sikorska"
date: "12 October 2018"
output: html_document
---
This code was written to fulfill the requirements of Assignment 4 of the Coursera Getting and Cleaning Data Course.
The code assumes that the dataset has been downloaded and has been unzipped, and the root directory of this download has been placed in a directory called Data, which itself is located in the Working Directory.

The data for this assignment was downloaded from on 11-Oct-2018:
https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip

The code required to perform the necessary tasks has been included into one function called run_analysis.R
This function takes no arguments and returns a dataframe with 48 columns and 6 rows.

The 48 columns correspond to the mean and standard deviation variables from were in the original dataset.  Some minor modifications were made to the column names (namely removing brackets and replacing a '-' with an underscore '_' character.)  This was to improve text parsing.

The row values correspond to the mean values of each of these columns for the six activity conditions of:
The rows correspond to the following 6 activity levels:

LAYING
SITTING
STANDING
WALKING
WALKING_DOWNSTAIRS
WALKING_UPSTAIRS

Final column names are provided in the columnNames.csv file.


```{r}
library(data.table)
library(dplyr)

```
Loads required libraries that will be used later on.


```{r}
 wd<-getwd()
```
Loads the working directory into memory so the file paths can be built from this.


``` {r}
    # Get location of files with respect to wd
    
    trainlocn<-paste(wd, "/Data/UCI HAR Dataset/train","/X_train.txt",sep="")
    trainlablocn<-paste(wd, "/Data/UCI HAR Dataset/train","/y_train.txt",sep="")
    testlocn<-paste(wd,"/Data/UCI HAR Dataset/test","/X_test.txt",sep="")
    testlablocn<-paste(wd,"/Data/UCI HAR Dataset/test","/y_test.txt",sep="")
    features_locn<-paste(wd,"/Data/UCI HAR Dataset","/features.txt",sep="")
    activitylabloc<-paste(wd,"/Data/UCI HAR Dataset","/activity_labels.txt",sep="")
```
Loads file locations into memory of all files that will be required:
    - location of file containing training dataset (X_train.txt)
    - location of file containing labels for activities associated with training dataset (y_train.txt)
    - location of file containing test dataset (X_test.txt)
    - location of file containing labels for activities associated with test dataset (y_test.txt)
    - location of file containing column names (what each data column represents) (features.txt)
    - location of file that maps the activity names to the activity numbers stored in the y_train.txt and y_test.txt files
    

```{r}
    # Read files into memory
    
    trainset<-read.table(trainlocn,header=FALSE,stringsAsFactors = FALSE)
    trainlabels<-read.table(trainlablocn,header=FALSE,stringsAsFactors = FALSE)
    testset<-read.table(testlocn,header=FALSE,stringsAsFactors = FALSE)
    testlabels<-read.table(testlablocn,header=FALSE,stringsAsFactors = FALSE)
    featuresdf<-read.delim(features_locn,header=FALSE,stringsAsFactors = FALSE)
    activity_labels<-read.table(activitylabloc,header=FALSE,stringsAsFactors = FALSE)
```
Loads all files into memory.


```{r}
#merge the datasets
    merged_data<-rbind(trainset,testset)
    activities<-inner_join(rbind(trainlabels,testlabels),activity_labels,by="V1")   
```

Merges the training and test files dataset.  
Merges the training and test label files and joins them to the activity_labels (to get the names of each activity, not just a number).

```{r}
   #Extract dataset column idenfiers from the Features textfile and remove brackets
    featurenames<-lapply(strsplit(featuresdf$V1," "),function (x) {x[2]})
    featurenames<-lapply(featurenames,function (x){gsub("[(,)]","",x) })
    featurenames<-lapply(featurenames,function (x){gsub("[-]","_",x) })

    colnames(merged_data)<-featurenames
```
Extracts the useful parts of the names of the feature vectors from the input data, which also includes a feature number.  This involves:
    - splitting the textfield into two parts and disgarding the first part (the number)
    - removing brackets in the names
    - replacing minus ('-') with an underscore ('_')
Then these feature names are applied to the columns of the merged dataset.

```{r}
#Determine which columns relate to mean or standard deviation
    col_list<-which(lapply(as.list(colnames(merged_data)),function (x) {grep("_std_",x)||grep("_mean_",x)}) == TRUE)

```
To determine which columns relate to mean or standard deviation, a list of relevant columns is determined that have '_std_' or '_mean_' in their column names.

```{r}
#Filter out only the columns that relate to mean or standard deviation
    merged_data<-merged_data[,col_list]
    
```
The dataset is filtered to only keep those columns which were returned in the previous step.

```{r}
#Split the data frame based on the activities 
    split_data<-split(merged_data,activities$V2)
```

The dataset in the dataframe is split based on type of activity.

```{r}
    splitresults<-simplify2array(lapply(split_data,function (x){apply(x,2,"mean")}))
```
Means are calculated for each feature at every activity level and then reformatted into a matrix.

```{r}
    ## Transpose the array
    rtn<-data.frame(aperm(splitresults))
```    
The array is transposed so that each feature/attribute is a separate column and each activity level is a row.
The array is then reformated as a dataframe as per the instructions.

This dataframe is returned from the function.


